!function(t,e){"use strict";"function"==typeof define?define.amd?define(function(t){var i=t("jquery"),s=t("lodash"),a=t("backbone"),l=t("backbone.view"),n=t("template");return e(i,s,a,l,n)}):define.cmd&&define(function(t,i,s){var a=t("jquery"),l=t("lodash"),n=t("backbone"),r=t("backbone.view"),o=t("template");return e(a,l,n,r,o)}):t.listView=e(t.listView)}(this,function(t,e,i,s,a){"use strict";var l={Type:{Waterfall:"waterfall",Pivot:"pivot"}},n=function(){this.type=l.Type.Waterfall,this.apiUrl=this.parentNode=this.$main=this.$list=this.$pullDown=this.$pullDownLabel=this.$pullUp=this.$pullUpLabel=this.topOffset=this.style=this.page=this.params=this.view=null,this.iScroll=null,this.activate=!0,this.page={result:"",pageNo:1,pageSize:0,pageTotal:0,total:0,prev:0,next:0,pageNoField:"",pageSizeField:"",pageTotalField:""},this.renderAfter=null};n.prototype.initConfiguration=function(e){this.view=e,this.setPage(e.getAttr("page")),this.setParams(e.getAttr("params")),this.apiUrl=e.getAttr("apiUrl"),this.style=e.getAttr("style"),this.parentNode=e.getAttr("parentNode");var i=e.getAttr("type");switch(this.$main=t(this.parentNode),this.renderAfter=e.getAttr("renderAfter"),this.style&&this.$main.css(this.style),i&&""!=i&&(this.type=i),this.type){case l.Type.Waterfall:this.initWaterfallMode();break;case l.Type.Pivot:this.initPivotMode()}},n.prototype.initWaterfallMode=function(){this.$warpiscroll=t("<div>",{id:"warp-iscroll"}),t(this.$warpiscroll,this.parentNode).append(this.bodyContext()),t(this.$warpiscroll,this.parentNode).append(this.pullUpTpl()),this.$warpiscroll.appendTo(this.$main),this.$list=this.$main.find("#events-list"),this.$pullDown=this.$main.find("#pull-down"),this.$pullDownLabel=this.$main.find("#pull-down-label"),this.$pullUp=this.$main.find("#pull-up"),this.$pullUpLabel=this.$main.find("#pull-up-label"),this.topOffset=-this.$pullDown.outerHeight(),this.bindIScroll(),this.setActivate(),this.load()},n.prototype.initPivotMode=function(){this.$warpiscroll=t("<div>",{id:"warp-iscroll"}),t(this.$warpiscroll,this.parentNode).append(this.bodyContext()),this.$warpiscroll.appendTo(this.$main),this.$list=this.$main.find("#events-list"),this.scrollView=this.view.getAttr("scrollView"),this.setActivate(),this.load()},n.prototype.renderAfterHandle=function(){switch(this.type){case l.Type.Waterfall:this.renderAfterWaterfallModeHandle();break;case l.Type.Pivot:this.renderAfterPivotModeHandle()}},n.prototype.renderAfterWaterfallModeHandle=function(){var e=this;e.resetLoading(e.$pullUp),setTimeout(function(){e.iScroll.refresh()},100);var i=t(".am-list-item-desced",e.parentNode).length;0==i&&e.$pullUp.remove(),this.page.next==this.page.pageTotal&&this.$pullUpLabel.text("已经到最后了"),this.renderAfter&&this.renderAfter()},n.prototype.renderAfterPivotModeHandle=function(){this.scrollView&&this.scrollView.refresh(),this.renderAfter&&this.renderAfter()},n.prototype.handlePullUp=function(){this.page.next<this.page.pageTotal&&(this.setLoading(this.$pullUp),this.page.next+=1,this.loadNextPage(),this.page.next==this.page.pageTotal&&this.$pullUpLabel.text("已经到最后了"))},n.prototype.handlePullDown=function(){},n.prototype.pullDownTpl=function(){return'<div class="pull-action loading" id="pull-down"><span class="am-icon-arrow-down pull-label" id="pull-down-label">下拉刷新</span><span class="am-icon-spinner am-icon-spin"></span></div>'},n.prototype.pullUpTpl=function(){return'<div class="pull-action loading" id="pull-up"><span class="am-icon-arrow-down pull-label" id="pull-up-label">上拉加载更多</span><span class="am-icon-spinner am-icon-spin"></span></div>'},n.prototype.bodyContext=function(){return'<ul class="am-list" id="events-list"><li class="am-list-item-desced"><div class="am-list-item-text">正在加载内容...</div></li></ul>'},n.prototype.setLoading=function(t){t.addClass("loading")},n.prototype.resetLoading=function(t){t.removeClass("loading")},n.prototype.bindIScroll=function(){var e,i=this,s=this.iScroll=new t.AMUI.iScroll(this.parentNode,{scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale",fadeScrollbars:!0}),i=this,a=!1;s.on("scrollStart",function(){this.y>=i.topOffset&&(a=!0),e=this.y}),s.on("scrollEnd",function(){a&&-1===this.directionY,a=!1,e===this.y&&1===this.directionY&&i.handlePullUp()})},n.prototype.getUrl=function(){var t=[];for(var e in this.params)this.params[e]&&t.push(e+"="+this.params[e]);return t.push(this.page.pageNoField+"="+this.page.pageNo),t.push(this.page.pageSizeField+"="+this.page.pageSize),this.apiUrl+"?"+t.join("&")},n.prototype.renderList=function(t){var e=this.view.getAttr("template"),i=a.compile(e,t);return i},n.prototype.load=function(){var e=this;t.getJSON(e.getUrl()).then(function(t){e.page.pageTotal=t[e.page.pageTotalField];var i=e.renderList(t[e.page.result]);e.$list.html(i),e.renderAfterHandle()},function(){console.log("Error...")})},n.prototype.reload=function(e){this.setParams(e),this.page.pageNo=1,this.page.pageTotal=0,this.$main=t(this.parentNode),this.$main.html(""),this.$warpiscroll=t("<div>",{id:"warp-iscroll"}),t(this.$warpiscroll,this.parentNode).append(this.bodyContext()),t(this.$warpiscroll,this.parentNode).append(this.pullUpTpl()),this.$warpiscroll.appendTo(this.$main),this.$list=this.$main.find("#events-list"),this.$pullDown=this.$main.find("#pull-down"),this.$pullDownLabel=this.$main.find("#pull-down-label"),this.$pullUp=this.$main.find("#pull-up"),this.$pullUpLabel=this.$main.find("#pull-up-label"),this.topOffset=-this.$pullDown.outerHeight(),this.bindIScroll(),this.load()},n.prototype.loadNextPage=function(){var e=this;t.getJSON(e.getUrl()).then(function(t){e.page.pageTotal=t[e.page.pageTotalField];var i=e.renderList(t[e.page.result]);e.$list.append(i),setTimeout(function(){e.iScroll.refresh()},100)},function(){console.log("Error...")}).always(function(){e.resetLoading(e.$pullUp)})},n.prototype.refresh=function(){this.iScroll.refresh()},n.prototype.setActivateOn=function(){var t={"transition-duration":".2s","transition-timing-function":"linear",transform:"translate(0px, 0px)"};this.$main.css(t)},n.prototype.setActivateOff=function(){var t=document.body.clientWidth,e={display:"none","transition-duration":"0s","transition-timing-function":"linear",transform:"translate("+t+"px, 0px)"};this.$main.css(e)},n.prototype.onActivate=function(t){var e=this;{if(1!=t)return 0==t?void this.setActivateOff():void 0;this.$main.css("display","block");var i=setTimeout(function(){e.setActivateOn(),clearTimeout(i)},100)}},n.prototype.setActivate=function(){var t=this.view.getAttr("activate");switch(t){case"true":this.setActivateOn();break;case"false":this.setActivateOff()}},n.prototype.setPage=function(e){var i=this,s={};t.extend(s,i.page,e),i.page=s},n.prototype.setParams=function(e){var i=this,s={};t.extend(s,i.params,e),i.params=s},n.prototype.setParam=function(t,e){this.params[t]=e};var r=i.Model.extend({idAttribute:"",defaults:{apiUrl:""}});return s.extend({id:"",model:new r,attrs:{parentNode:null,template:null,page:{result:"",pageNo:0,pageSize:0,pageNoField:"pageNum",pageSizeField:"pageSize",pageTotalField:"lastPageNumber"},params:{}},events:{},setup:function(){var t=this,e=(t.getAttr("parentNode"),t.getAttr("type"),t.getAttr("data"),new n);e.initConfiguration(t),t.setAttr("listView",e),document.addEventListener("touchmove",function(t){t.preventDefault()},!1)},setPage:function(t){this.getAttr("listView").setPage(t)},setParams:function(t){this.getAttr("listView").setParams(t)},setParam:function(t,e){this.getAttr("listView").setParam(t,e)},reload:function(t){this.getAttr("listView").reload(t)},refreshTouchLayout:function(){var t=this.getAttr("listView");t.type==l.Type.Waterfall&&t.refresh()},onActivate:function(t){var e=this.getAttr("listView");e.onActivate(t)}})});