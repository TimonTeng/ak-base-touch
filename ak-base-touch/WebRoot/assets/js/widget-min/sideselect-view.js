!function(t,e){"use strict";"function"==typeof define?define.amd?define(function(t){var i=t("jquery"),o=t("lodash"),n=t("backbone"),r=t("backbone.view"),a=t("template"),l=t("sidebar");return e(i,o,n,r,a,l)}):define.cmd&&define(function(t,i,o){var n=t("jquery"),r=t("lodash"),a=t("backbone"),l=t("backbone.view"),c=t("template"),s=t("sidebar");return e(n,r,a,l,c,s)}):t.scrollView=e(t.scrollView)}(this,function(t,e,i,o,n,r){"use strict";function a(t,e){this.config=t,this.sideSelectView=e,this.sideView=null,this.dataFormat=null,this.title=this.type=this.data=this.result=this.apiUrl=this.touchTargetId=this.displayField=null,this.loadOnce=!0,this.loadComplate=!1,this.loadComplateCallBack=null,this.renderText=null,this.touchDisplay=null,this.join=this.joinPropertys=null,this.$touchEl=null,this.$iscroll=null,this.initConfig()}function l(){this.parentNode=this.configs=this.view=null,this.sideSelectConfigs={},this.Sidebar=r,this.initial=!0,this.$main=null,this.block=0}var c=i.Model.extend({idAttribute:"",defaults:{}}),s={single:"single",multiple:"multiple",date:"date"};return a.prototype.initConfig=function(){this.title=this.config.title||"",this.type=this.config.type||s.sigle,this.selectData=this.defineDataType(),this.result=this.config.result||"form",this.apiUrl=this.config.apiUrl||void 0,this.touchTargetId=this.config.touchTargetId||void 0,this.displayField=this.config.displayField||void 0,this.join=this.config.join||void 0,this.joinPropertys=this.config.joinPropertys||void 0,this.loadOnce="loadOnce"in this.config?this.config.loadOnce:this.loadOnce,this.renderText=this.config.renderText||void 0},a.prototype.defineDataType=function(){switch(this.type){case s.single:return{};case s.multiple:return{};default:return null}},a.prototype.putSelectData=function(t,e){this.selectData[t]=e},a.prototype.delSelectData=function(t){delete this.selectData[t]},a.prototype.checkTouchTargetId=function(){var e=this.$touchEl=t("#"+this.touchTargetId);if(0===e.length)throw new Error("找不到指定 "+this.touchTargetId+" id element")},a.prototype.singleConfigVerify=function(){this.checkTouchTargetId(),this.dataFormat=this.selectDataToObject},a.prototype.multipleConfigVerify=function(){this.checkTouchTargetId(),this.dataFormat=this.selectDataToArray},a.prototype.configVerify=function(){switch(this.type){case s.single:this.singleConfigVerify();break;case s.multiple:this.multipleConfigVerify();break;default:throw new Error("未指定 config.type 参数值")}},a.prototype.initSideView=function(){var t=this;if(t.touchDisplay=t.sideSelectView.createTouchDisplayLoadPolicy(this),null==t.touchDisplay)throw new Error("SideSelectConfig  createTouchDisplayLoadPolicy, 创建展示选项卡加载数据接口失败");this.touchEvent(t.$touchEl,null,{start:function(t){},move:function(t){},end:function(e){t.sideView=t.sideView||t.createSideView(),t.touchDisplay(t)}})},a.prototype.repeatBindTouchEvent=function(){var t=this;t.checkTouchTargetId(),t.touchEvent(t.$touchEl,null,{start:function(t){},move:function(t){},end:function(e){t.touchDisplay(t)}})},a.prototype.setSelectedValue=function(){var e=this.sideView.getAttr("sidebar");for(var i in this.selectData){var o=t("li[data-key="+i+"]",e.$context);o=o.get(0)||null,o&&this.selectedOn(o)}},a.prototype.getParentFirstSelectData=function(){var t=this.sideSelectView.getSideSelectConfig(this.join),e=t.selectData,i=null;for(var o in e){i=e[o];break}return i},a.prototype.convertDataToSelectData=function(t){var e=this;if(t instanceof Array)return console.log("SideSelectConfig.prototype.convertDataToSelectData 1.1"),this.selectData={},void t.forEach(function(t,i){if("id"in t==!1)throw new Error("参数未指定 id属性");e.selectData[t.id]=t});if(t instanceof Object){if(console.log("SideSelectConfig.prototype.convertDataToSelectData 1.2"),"id"in t==!1)throw new Error("参数未指定 id属性");return this.selectData[t.id]=t,void console.log(JSON.stringify(this.selectData))}},a.prototype.setSelectOptionData=function(t){console.log("SideSelectConfig.prototype.setSelectOptionData 1");var e=this;if(e.selectData={},e.convertDataToSelectData(t),!e.isJoin()||null!=e.data&&0!=e.data.length)var i=setInterval(function(){null!=e.data&&(console.log(JSON.stringify(e.data)),e.findOptionOnDataAttribute(),clearInterval(i),console.log("SideSelectConfig.prototype.setSelectOptionData 2.2"))},100);else{console.log("SideSelectConfig.prototype.setSelectOptionData 2.1");var o=e.getParentFirstSelectData(),n=e.formatApiUrlByObject(o);e.sideSelectView.onloadRemoteDataByCallback(n,e,function(){e.findOptionOnDataAttribute()})}},a.prototype.findOptionOnDataAttribute=function(){var t=this,e=t.selectData,i=this.data;for(var o in e){var n=e[o].id;i.forEach(function(t,i){parseInt(n)===parseInt(t.id)&&(e[n]=t)})}},a.prototype.createSideView=function(){switch(console.log("SideSelectConfig.prototype.createSideView this.type ="+this.type),this.type){case s.single:return this.createSingleSiderBar();case s.multiple:return this.createMultipleSiderBar();default:return null}},a.prototype.createSingleSiderBar=function(){var t=this,e=new this.sideSelectView.Sidebar({id:t.touchTargetId,title:t.title,returnIcon:"icon_return",style:{zIndex:3999},onOpen:function(){var e=5,i=setInterval(function(){t.$iscroll.refresh(),0===--e&&clearInterval(i)},200)},submit:function(){t.onSelect()}});return e},a.prototype.createMultipleSiderBar=function(){var t=this,e=new this.sideSelectView.Sidebar({id:t.touchTargetId,title:t.title,returnIcon:"icon_return",style:{zIndex:3999},onOpen:function(){var e=5,i=setInterval(function(){t.$iscroll.refresh(),0===--e&&clearInterval(i)},200)},submit:function(){t.onSelect()}});return e},a.prototype.onSelect=function(){this.config.onSelect&&this.config.onSelect(this.dataFormat())},a.prototype.formatApiUrl=function(){if(!this.isJoin())return this.apiUrl;var t=this.sideSelectView.getSideSelectConfig(this.join),e=t.dataFormat();return this.formatApiUrlByObject(e)},a.prototype.formatApiUrlByObject=function(t){var e=[];for(var i in this.joinPropertys)this.joinPropertys[i]&&e.push("&"+this.joinPropertys[i]+"="+t[i]);var o=-1!=this.apiUrl.indexOf("?")?this.apiUrl:this.apiUrl+"?";return o+e.join("&")},a.prototype.isJoin=function(){var t=this.sideSelectView.getSideSelectConfig(this.join);return t?!0:!1},a.prototype.addScroll=function(t){this.$iscroll=new IScroll(t,{click:!0})},a.prototype.selectDataToObject=function(){var t={};for(var e in this.selectData){t=this.selectData[e];break}return t},a.prototype.selectDataToArray=function(){var t=new Array;for(var e in this.selectData)t.push(this.selectData[e]);return t},a.prototype.touchEvent=function(e,i,o){t.touchEvent(e,i,o)},a.prototype.createSelectDataContext=function(e){var i=this,o=t("<div>",{id:"warp_root","class":"warp_mark"}),n=t("<ul>",{id:"warp_ul_root","class":"warp_context"});return n.appendTo(o),e.forEach(function(e,o){var r=t("<li>",{"data-object":JSON.stringify(e),"data-key":e.id});r.text(e[i.displayField]),r.appendTo(n)}),o},a.prototype.loadAfterRender=function(t){switch(this.type){case s.single:this.renderOnSingle(t);break;case s.multiple:this.renderOnMultiple(t)}},a.prototype.renderSelectOptionText=function(){if(this.renderText){var t=this.dataFormat();this.renderText(t)}},a.prototype.renderOnSingle=function(t){var e=this;this.sideView.html(t),this.addScroll("#am-plugin-sidebar-context-"+this.touchTargetId),this.touchEvent("li",t,{start:function(t){e.selectedAllOff(),e.selectedOn(t.target)},move:function(t){e.selectedOff(t.target)},end:function(t){}})},a.prototype.renderOnMultiple=function(t){var e=this;this.sideView.html(t),this.addScroll("#am-plugin-sidebar-context-"+this.touchTargetId),this.touchEvent("li",t,{start:function(t){var i=t.target.getAttribute("selected");i?e.selectedOff(t.target):e.selectedOn(t.target)},move:function(t){e.selectedOff(t.target)},end:function(t){}})},a.prototype.selectedAllOff=function(){var e=this.sideView.getAttr("sidebar");t("[selected]",e.$context).css("backgroundColor","#fff"),this.selectData={}},a.prototype.selectedOff=function(e){var i=t(e).data("object");e.style.backgroundColor="#fff",e.removeAttribute("selected"),this.delSelectData(i.id)},a.prototype.selectedOn=function(e){var i=t(e).data("object");e.style.backgroundColor="#ececec",e.setAttribute("selected",!0),this.putSelectData(i.id,i)},l.prototype.loadConfiguration=function(e){var i={apiUrl:e.apiUrl,flag:!0};if(!e.isJoin())return i;var o=JSON.stringify(e.selectData);return"{}"===o?t.extend(i,{flag:!1}):t.extend(i,{flag:e.formatApiUrl()}),i},l.prototype.onload=function(t){var e=this.loadConfiguration(t);e.flag&&this.onloadRemoteData(e.apiUrl,t)},l.prototype.onloadRemoteData=function(e,i){var o=this;o.onloadStartLock(),t.getJSON(e,null,function(t){i.data=t[i.result],i.loadComplate=!0,i.loadComplateCallBack&&i.loadComplateCallBack(),o.onloadCompleteUnLock()}).error(function(){console.log("Ajax Request Error!")})},l.prototype.onloadRemoteDataByCallback=function(e,i,o){var n=this;n.onloadStartLock(),t.getJSON(e,null,function(t){i.data=t[i.result],i.loadComplate=!0,o&&o(),n.onloadCompleteUnLock()}).error(function(){console.log("Ajax Request Error!")})},l.prototype.renderSelectOptionDom=function(e){var i=t("<div>",{id:"warp_root","class":"warp_mark"}),o=t("<ul>",{id:"warp_ul_root","class":"warp_context"});return o.appendTo(i),e.data.forEach(function(i,n){var r=t("<li>",{"data-object":JSON.stringify(i),"data-key":i.id});r.text(i[e.displayField]),r.appendTo(o)}),i},l.prototype.initConfiguration=function(e){this.view=e,this.parentNode=e.getAttr("parentNode"),this.configs=e.getAttr("configs"),this.initial=this.convertBool(e.getAttr("initial"))||this.initial,this.$main=t(this.parentNode),this.init=!1,1==this.initial&&this.initSideSelectConfigs()},l.prototype.repeatBindTouchEvent=function(){for(var t in this.sideSelectConfigs)this.sideSelectConfigs[t].repeatBindTouchEvent()},l.prototype.convertBool=function(t){switch(t){case"false":return new Boolean(!1);case"true":return new Boolean(!0)}return void 0},l.prototype.analyzingPolicy=function(t){var e="a";switch(e=t.loadOnce===!0?"a":"b",t.isJoin()&&(e="c"),e){case"a":return"a";case"b":return"b";case"c":return"c"}return null},l.prototype.createTouchDisplayLoadPolicy=function(t){var e=function(t){var e=t.sideSelectView.renderSelectOptionDom(t);t.loadAfterRender(e),t.setSelectedValue(),t.sideView.open()},i=function(t){t.loadComplateCallBack=function(){var e=t.sideSelectView.renderSelectOptionDom(t);t.loadAfterRender(e),t.setSelectedValue(),t.sideView.open()};var e=t.formatApiUrl();t.sideSelectView.onloadRemoteData(e,t)},o=function(){t.loadComplateCallBack=function(){var e=t.sideSelectView.renderSelectOptionDom(t);t.loadAfterRender(e),t.setSelectedValue(),t.sideView.open()};var e=t.formatApiUrl();t.sideSelectView.onloadRemoteData(e,t)},n=this.analyzingPolicy(t);switch(n){case"a":return e;case"b":return i;case"c":return o;default:return null}},l.prototype.initSideSelectConfigs=function(){if(this.init===!0)return void this.repeatBindTouchEvent();for(var t=0;t<this.configs.length;t++){var e=new a(this.configs[t],this);e.configVerify(),this.setSideSelectConfig(e),this.onload(e),this.initSideSelectConfigOnSelectEvent(e),this.init=!0}},l.prototype.initSideSelectConfigOnSelectEvent=function(t){t.initSideView()},l.prototype.getSideSelectConfig=function(t){return this.sideSelectConfigs[t]||null},l.prototype.setSideSelectConfig=function(t){this.sideSelectConfigs[t.touchTargetId]=t},l.prototype.setSelectOptionValue=function(t,e){var i=this.getSideSelectConfig(t);i.setSelectOptionData(e)},l.prototype.isAsyncOnloadBlock=function(){return this.block>0},l.prototype.onloadStartLock=function(){this.block=this.block<0?0:this.block+1},l.prototype.onloadCompleteUnLock=function(){--this.block},l.prototype.initSelectDataText=function(){var t=this,e=setInterval(function(){if(!t.isAsyncOnloadBlock()){var i=t.sideSelectConfigs;for(var o in i){var n=i[o];n.renderSelectOptionText()}clearInterval(e)}},200)},o.extend({id:"",model:new c,attrs:{parentNode:null},events:{},setData:function(t,e){var i=this.getAttr("sideSelectView");i.setData(t,e)},initSideSelectConfigs:function(){var t=this.getAttr("sideSelectView");t.initSideSelectConfigs()},setSelectOptionValue:function(t,e){var i=this.getAttr("sideSelectView");i.setSelectOptionValue(t,e)},initSelectDataText:function(){var t=this.getAttr("sideSelectView");t.initSelectDataText()},setup:function(){var t=this,e=new l;e.initConfiguration(t),t.setAttr("sideSelectView",e),document.addEventListener("touchmove",function(t){t.preventDefault()},!1)}})});