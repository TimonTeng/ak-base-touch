!function(t,i){"use strict";"function"==typeof define?define.amd?define(function(t){var e=t("jquery"),n=t("lodash"),r=t("backbone"),o=t("backbone.view"),c=t("sidebar"),s=t("template");return i(e,n,r,o,s,c)}):define.cmd&&define(function(t,e,n){var r=t("jquery"),o=t("lodash"),c=t("backbone"),s=t("backbone.view"),a=t("sidebar"),l=t("template");return i(r,o,c,s,l,a)}):t.AddressSelector=i(t.AddressSelector)}(this,function(t,i,e,n,r,o){"use strict";function c(){this.type=s.City,this.result=this.view=this.sidebar=null,this.province=this.city=this.district=null,this.data={province:null,city:null,district:null},this.selectData={province:null,city:null,district:null},this.sidebar=this.createSidebar()}var s={Province:"Province",City:"City",ProvinceCity:"ProvinceCity",ProvinceCityDistrict:"ProvinceCityDistrict"};c.prototype.initConfiguration=function(t){this.view=t||null,this.type=t.getAttr("type")||this.type,this.result=t.getAttr("result")||"data",this.province=t.getAttr("province")||null,this.city=t.getAttr("city")||null,this.district=t.getAttr("district")||null,this.buildJsonReader()},c.prototype.createSidebar=function(){var t=this;return new o({title:"城市选择",returnIcon:"icon_return",style:{zIndex:200},submit:function(){t.submit()},returnAfter:function(){}})},c.prototype.submit=function(){var t=this.view.getAttr("submit");t&&t(this.selectData)},c.prototype.load=function(i){var e=this;t.getJSON(i.apiUrl,null,function(t){i.formatData(t),i.renderAfter(),e.sidebar.open()})},c.prototype.open=function(){switch(this.type){case s.Province:this.openProvinceView();break;case s.City:this.openCityView();break;case s.ProvinceCity:this.openProvinceCityView();break;case s.ProvinceCityDistrict:this.openProvinceCityDistrictView()}},c.prototype.buildJsonReader=function(){var i=this;this.JsonReader={apiUrl:i.city.apiUrl,formatData:function(e){i.data.city=e;var n=t("<div>",{id:"city-root","class":"am-plugin-sidebar-scroll"}),r=t("<div>",{id:"city-context"});r.appendTo(n);var o=t("<div>",{id:"warp_root","class":"warp_mark"}),c=t("<ul>",{id:"warp_ul_root","class":"warp_context"}),s=e[i.result];if(s)for(var a=0;a<s.length;a++){var l=s[a],d=t("<li>",{"data-object":JSON.stringify(l),"data-select":!1});d.text(l[i.city.displayField]),d.appendTo(c)}c.appendTo(o),o.appendTo(r),i.sidebar.appendHtml(n)},renderAfter:function(){new t.AMUI.iScroll("#city-root",{scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale",fadeScrollbars:!0});var e=!1,n=null;t(".warp_context li","#city-root").unbind("touchstart").bind("touchstart",function(i){n&&n.css("backgroundColor","#fff"),e=!0,n=t(i.target),t(i.target).css("backgroundColor","#ececec")}),t(".warp_context li","#city-root").unbind("touchmove").bind("touchmove",function(t){e=!1,n.css("backgroundColor","#fff")}),t(".warp_context li","#city-root").unbind("touchend").bind("touchend",function(t){e&&(i.selectData.city=n.data("object"))})}}},c.prototype.openProvinceView=function(){this.load()},c.prototype.openCityView=function(){return this.data.city?void this.sidebar.open():void this.load(this.JsonReader)},c.prototype.openProvinceCityView=function(){this.load()},c.prototype.openProvinceCityDistrictView=function(){this.load()};var a=e.Model.extend({idAttribute:"",defaults:{}});return n.extend({id:"",model:new a,attrs:{parentNode:null},events:{},setup:function(){var t=this,i=new c;i.initConfiguration(t),t.setAttr("addressSelector",i),document.addEventListener("touchmove",function(t){t.preventDefault()},!1)},open:function(){var t=this.getAttr("addressSelector");t.open()}})});